name: CI
on: push
jobs:
  trufflehog:
    runs-on: ubuntu-latest

    env:
      ORG_NAME: ${{ secrets.TRUFFLEHOG_ORG_NAME }}
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      REPO_NAME: ${{ env.GITHUB_REPOSITORY }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Secret Scanning
      run: |
        echo $REPO_NAME
        echo "Branch name is ${GITHUB_REF##*/}"
        docker run --rm -e DOCKER_TTY=0 -v "$PWD:/pwd" trufflesecurity/trufflehog:latest git https://github.com/trufflesecurity/test_keys --only-verified --json > trufflehog_result.txt  
        # Add error handling if the previous command fails
        if [ $? -ne 0 ]; then
          echo "Trufflehog execution failed"
          exit 1
        fi

    - name: Upload Trufflehog Result
      uses: actions/upload-artifact@v2
      with:
        name: TruffleHog Results
        path: trufflehog_result.txt
